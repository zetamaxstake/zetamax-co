import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, onSnapshot, serverTimestamp, runTransaction, writeBatch } from 'firebase/firestore';
import { ShieldCheck, Users, TrendingUp, Link, Copy, Crown, BarChart, UserCog, DollarSign, LogIn, ChevronsRight, ChevronsDown, X, Wallet, Settings, Send, CheckCircle, XCircle } from 'lucide-react';

// --- Firebase Configuration ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'hybrid-income-app';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Platform Configuration ---
const STAKING_PLANS = {
    bronze: { name: 'Bronze', days: 365, dailyRate: 0.005, totalReturn: 1.825 },
    silver: { name: 'Silver', days: 540, dailyRate: 0.006, totalReturn: 3.24 },
    gold: { name: 'Gold', days: 720, dailyRate: 0.0075, totalReturn: 5.40 },
};
const MINIMUM_STAKE = 100;
const DIRECT_REFERRAL_BONUS_RATE = 0.10;
const TEAM_LEVEL_INCOME_RATES = [0.12, 0.08, 0.06, 0.05, 0.04, 0.03, 0.02, 0.01, 0.005, 0.005];
const ROYALTY_QUALIFICATION_BUSINESS = 1000000;
const ROYALTY_POOL_RATE = 0.03;

// --- Main App Component ---
export default function App() {
    const [auth, setAuth] = useState(null);
    const [db, setDb] = useState(null);
    const [user, setUser] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isLoading, setIsLoading] = useState(true);
    const [view, setView] = useState('user'); // 'user' or 'admin'
    const [notification, setNotification] = useState({ show: false, message: '', type: 'info' });

    const showNotification = (message, type = 'success', duration = 4000) => {
        setNotification({ show: true, message, type });
        setTimeout(() => setNotification({ show: false, message: '', type: 'info' }), duration);
    };

    useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) return;
        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);
            setAuth(authInstance);
            setDb(dbInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
                setIsAuthReady(true);
                if (currentUser) {
                    const userDocRef = doc(dbInstance, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);
                    onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) setUser({ uid: currentUser.uid, ...docSnap.data() });
                        else setUser(null);
                        setIsLoading(false);
                    }, (error) => { console.error("User snapshot error:", error); setIsLoading(false); });
                } else {
                    try {
                      if (initialAuthToken) await signInWithCustomToken(authInstance, initialAuthToken);
                      else await signInAnonymously(authInstance);
                    } catch(e) { console.error("Sign in failed", e)}
                    setIsLoading(false);
                }
            });
            return () => unsubscribe();
        } catch (error) { console.error("Firebase Init Error:", error); setIsLoading(false); }
    }, []);

    const appState = { db, auth, user, showNotification };

    if (isLoading || !isAuthReady) return <LoadingScreen />;
    
    return (
        <div className="bg-gray-900 text-white min-h-screen font-sans">
            <Notification notification={notification} onClose={() => setNotification({ show: false, message: '', type: 'info' })} />
            {!user ? ( <AuthScreen {...appState} /> ) : (
                <>
                    <Header user={user} view={view} setView={setView} />
                    {view === 'user' ? <UserInterface {...appState} /> : <AdminInterface {...appState} />}
                </>
            )}
        </div>
    );
}

// --- Screens and Main Components ---
const LoadingScreen = () => <div className="bg-gray-900 text-white min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-yellow-400"></div></div>;

const AuthScreen = ({ db, auth, showNotification }) => {
    const [username, setUsername] = useState('');
    const [referrerCode, setReferrerCode] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const ref = params.get('ref');
        if (ref) setReferrerCode(ref);
    }, []);

    const handleCreateAccount = async () => {
        if (!username || username.length < 3) {
            showNotification("Username must be at least 3 characters.", "error");
            return;
        }
        setIsLoading(true);
        const currentUser = auth.currentUser;
        if (!currentUser) { showNotification("Authentication error. Please refresh.", "error"); setIsLoading(false); return; }

        try {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);
            await runTransaction(db, async (transaction) => {
                const existingUserDoc = await transaction.get(userRef);
                if(existingUserDoc.exists()) throw new Error("User is already registered!");

                let referredBy = null;
                let upline = [];
                if (referrerCode) {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where("referralId", "==", referrerCode));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const referrerDoc = querySnapshot.docs[0];
                        referredBy = referrerDoc.id;
                        const referrerData = referrerDoc.data();
                        upline = [referrerDoc.id, ...(referrerData.upline || [])].slice(0, 10);
                    } else { showNotification("Invalid referrer ID. Continuing without a referrer.", "info"); }
                }
                
                const globalStatsRef = doc(db, 'artifacts', appId, 'public', 'data', 'globalStats', 'singleton');
                const globalStatsDoc = await transaction.get(globalStatsRef);
                const isFirstUser = !globalStatsDoc.exists() || globalStatsDoc.data().totalUsers === 0;

                const newUser = {
                    username, uid: currentUser.uid, role: isFirstUser ? 'admin' : 'user',
                    referralId: `ztmx-${Math.random().toString(36).substr(2, 9)}`,
                    referredBy, upline, createdAt: serverTimestamp(),
                    availableBalance: 0, totalStaked: 0, teamBusiness: 0, isRoyaltyQualified: false, totalWithdrawn: 0,
                    income: { staking: 0, direct: 0, team: 0, royalty: 0 },
                };
                
                transaction.set(userRef, newUser);

                if (globalStatsDoc.exists()) {
                    transaction.update(globalStatsRef, { totalUsers: (globalStatsDoc.data().totalUsers || 0) + 1 });
                } else {
                    transaction.set(globalStatsRef, {
                        totalPlatformStaked: 0, weeklyStakingVolume: 0, totalUsers: 1, masterDepositAddress: 'Not Set'
                    });
                }
            });
        } catch (error) {
            console.error("Account creation failed:", error);
            showNotification(error.message || "Could not create account.", "error");
        } finally { setIsLoading(false); }
    };

    return (
        <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full text-center">
                <h1 className="text-3xl font-bold mb-2 text-yellow-400">Create Your Account</h1>
                <div className="flex flex-col gap-4 mt-6">
                    <input type="text" value={username} onChange={e => setUsername(e.target.value)} placeholder="Enter your username" className="input-style"/>
                    <input type="text" value={referrerCode} onChange={e => setReferrerCode(e.target.value)} placeholder="Referral Code (Optional)" className="input-style"/>
                    <button onClick={handleCreateAccount} disabled={isLoading} className="btn-primary flex items-center justify-center gap-2">
                        <LogIn size={20} /> {isLoading ? 'Creating...' : 'Enter Platform'}
                    </button>
                </div>
            </div>
        </div>
    );
};

const Header = ({ user, view, setView }) => (
    <header className="bg-gray-800/70 backdrop-blur-sm p-4 sticky top-0 z-40 flex justify-between items-center border-b border-gray-700">
        <h1 className="text-xl md:text-2xl font-bold text-yellow-400 flex items-center gap-2"><ShieldCheck /> Hybrid Income</h1>
        <div className="flex items-center gap-4">
            {user.role === 'admin' && (
                <div className="flex items-center bg-gray-700 rounded-full p-1">
                    <button onClick={() => setView('user')} className={`px-3 py-1 rounded-full text-sm font-semibold transition ${view === 'user' ? 'bg-yellow-500 text-gray-900' : 'text-gray-300'}`}>User</button>
                    <button onClick={() => setView('admin')} className={`px-3 py-1 rounded-full text-sm font-semibold transition ${view === 'admin' ? 'bg-yellow-500 text-gray-900' : 'text-gray-300'}`}>Admin</button>
                </div>
            )}
            <span className="text-sm text-gray-400 hidden sm:block">Welcome, <span className="font-bold text-yellow-300">{user.username}</span></span>
        </div>
    </header>
);

const UserInterface = ({ user, db, showNotification }) => {
    const totalIncome = Object.values(user.income || {}).reduce((a, b) => a + b, 0);
    const totalEarnings = totalIncome - (user.totalWithdrawn || 0);

    return (
        <main className="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-2 space-y-8">
                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                    <StatCard icon={<Wallet/>} title="Available Balance" value={`${(user.availableBalance || 0).toFixed(2)} ZTMX`} color="blue"/>
                    <StatCard icon={<DollarSign/>} title="Withdrawable Earnings" value={`${totalEarnings.toFixed(2)} ZTMX`} color="green"/>
                </div>
                
                <WalletManagement user={user} db={db} showNotification={showNotification} totalEarnings={totalEarnings} />
                <StakingSection user={user} db={db} showNotification={showNotification} />
                <TransactionHistory userId={user.uid} db={db} type="user" />
            </div>
            <div className="lg:col-span-1 space-y-8">
                <ReferralSection user={user} showNotification={showNotification} />
                <RoyaltyStatus user={user} />
                <TeamView user={user} db={db} />
            </div>
        </main>
    );
};

// --- Child Components for User Interface ---

const WalletManagement = ({user, db, showNotification, totalEarnings}) => {
    const [view, setView] = useState('deposit'); // deposit or withdraw
    const [depositAmount, setDepositAmount] = useState('');
    const [txId, setTxId] = useState('');
    const [withdrawAmount, setWithdrawAmount] = useState('');
    const [withdrawAddress, setWithdrawAddress] = useState('');
    const [masterAddress, setMasterAddress] = useState('Loading...');
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'globalStats', 'singleton');
        getDoc(statsRef).then(docSnap => {
            if (docSnap.exists()) {
                setMasterAddress(docSnap.data().masterDepositAddress || 'Address not set by admin');
            }
        });
    }, [db]);

    const handleDepositRequest = async () => {
        const amount = parseFloat(depositAmount);
        if (isNaN(amount) || amount <= 0 || !txId) {
            showNotification("Please enter a valid amount and Transaction ID.", "error");
            return;
        }
        setIsLoading(true);
        try {
            const requestRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'depositRequests'));
            await setDoc(requestRef, {
                userId: user.uid, username: user.username, amount, txId, status: 'pending', createdAt: serverTimestamp()
            });
            showNotification("Your deposit request has been submitted. Please wait for approval.", "success");
            setDepositAmount(''); setTxId('');
        } catch(e) {
            showNotification("Request failed.", "error");
            console.error(e);
        } finally { setIsLoading(false); }
    };
    
    const handleWithdrawRequest = async () => {
        const amount = parseFloat(withdrawAmount);
        if (isNaN(amount) || amount <= 0 || !withdrawAddress) {
            showNotification("Enter a valid amount and wallet address.", "error");
            return;
        }
        if (amount > totalEarnings) {
            showNotification("You do not have enough withdrawable earnings.", "error");
            return;
        }
        setIsLoading(true);
        try {
            const requestRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'withdrawalRequests'));
            await setDoc(requestRef, {
                userId: user.uid, username: user.username, amount, walletAddress: withdrawAddress, status: 'pending', createdAt: serverTimestamp()
            });
            showNotification("Your withdrawal request has been submitted.", "success");
            setWithdrawAmount(''); setWithdrawAddress('');
        } catch(e) {
            showNotification("Request failed.", "error");
            console.error(e);
        } finally { setIsLoading(false); }
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
            <div className="flex border-b border-gray-700 mb-4">
                <button onClick={() => setView('deposit')} className={`px-4 py-2 font-semibold ${view === 'deposit' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400'}`}>Deposit</button>
                <button onClick={() => setView('withdraw')} className={`px-4 py-2 font-semibold ${view === 'withdraw' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400'}`}>Withdraw</button>
            </div>
            {view === 'deposit' ? (
                <div>
                    <h3 className="font-bold text-gray-300">Company's Deposit Address:</h3>
                    <div className="my-2 p-3 bg-gray-900 rounded-lg text-yellow-300 font-mono break-words">{masterAddress}</div>
                    <p className="text-sm text-gray-400 mb-4">Send ZTMX to this address and fill the details below.</p>
                    <div className="space-y-4">
                        <input type="number" value={depositAmount} onChange={e => setDepositAmount(e.target.value)} placeholder="Amount you sent" className="input-style w-full" />
                        <input type="text" value={txId} onChange={e => setTxId(e.target.value)} placeholder="Transaction ID (TxID)" className="input-style w-full" />
                        <button onClick={handleDepositRequest} disabled={isLoading} className="btn-primary w-full">{isLoading ? 'Submitting...' : 'Submit Deposit Request'}</button>
                    </div>
                </div>
            ) : (
                <div className="space-y-4">
                    <input type="number" value={withdrawAmount} onChange={e => setWithdrawAmount(e.target.value)} placeholder="Amount to withdraw" className="input-style w-full" />
                    <input type="text" value={withdrawAddress} onChange={e => setWithdrawAddress(e.target.value)} placeholder="Your ZTMX Wallet Address" className="input-style w-full" />
                    <button onClick={handleWithdrawRequest} disabled={isLoading} className="btn-primary w-full">{isLoading ? 'Submitting...' : 'Submit Withdrawal Request'}</button>
                </div>
            )}
        </div>
    );
};

const StakingSection = ({ user, db, showNotification }) => {
    const [stakeAmount, setStakeAmount] = useState('');
    const [selectedPlan, setSelectedPlan] = useState('bronze');
    const [isLoading, setIsLoading] = useState(false);

    const handleStake = async () => {
        const amount = parseFloat(stakeAmount);
        if (isNaN(amount) || amount < MINIMUM_STAKE) {
            showNotification(`Minimum stake is ${MINIMUM_STAKE} ZTMX.`, "error");
            return;
        }
        if (amount > user.availableBalance) {
            showNotification("You do not have enough funds in your available balance.", "error");
            return;
        }
        setIsLoading(true);
        
        try {
            await runTransaction(db, async (transaction) => {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists()) throw new Error("User not found");
                
                const newBalance = userDoc.data().availableBalance - amount;
                if (newBalance < 0) throw new Error("Insufficient balance.");

                // Create Stake
                const stakeRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'stakes'));
                transaction.set(stakeRef, { userId: user.uid, planId: selectedPlan, amount, status: 'active', startDate: serverTimestamp() });
                
                // Update user
                transaction.update(userRef, {
                    availableBalance: newBalance,
                    totalStaked: userDoc.data().totalStaked + amount
                });
                
                // Log transaction
                const transRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
                transaction.set(transRef, { userId: user.uid, type: 'stake', amount, description: `Staked in ${STAKING_PLANS[selectedPlan].name} plan`, timestamp: serverTimestamp() });
            });
            
            await distributeBonuses(db, user, amount);
            showNotification(`Successfully staked ${amount} ZTMX!`, "success");
            setStakeAmount('');
        } catch (error) {
            console.error("Staking failed:", error);
            showNotification(error.message || "Staking failed.", "error");
        } finally { setIsLoading(false); }
    };
    
    return (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
            <h2 className="text-xl font-semibold mb-4 text-yellow-300">Stake from Available Balance</h2>
            <div className="grid grid-cols-3 gap-4 mb-4">
                {Object.entries(STAKING_PLANS).map(([id, { name, days }]) => <button key={id} onClick={() => setSelectedPlan(id)} className={`p-3 rounded-lg text-center transition ${selectedPlan === id ? 'bg-yellow-500 text-gray-900 font-bold' : 'bg-gray-700 hover:bg-gray-600'}`}><p>{name}</p><p className="text-xs">{days} Days</p></button>)}
            </div>
            <div className="flex flex-col sm:flex-row gap-4">
                <input type="number" value={stakeAmount} onChange={e => setStakeAmount(e.target.value)} placeholder={`Min ${MINIMUM_STAKE} ZTMX`} className="input-style flex-grow"/>
                <button onClick={handleStake} disabled={isLoading} className="btn-primary">{isLoading ? 'Staking...' : 'Stake Now'}</button>
            </div>
        </div>
    );
};

// --- Admin Interface ---
const AdminInterface = ({ db, showNotification }) => {
    const [view, setView] = useState('deposits'); // deposits, withdrawals, settings
    return(
        <main className="p-4 md:p-8 space-y-8">
            <h2 className="text-3xl font-bold text-yellow-400">Admin Dashboard</h2>
            <div className="flex border-b border-gray-700 mb-4">
                <button onClick={() => setView('deposits')} className={`px-4 py-2 font-semibold ${view === 'deposits' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400'}`}>Deposit Requests</button>
                <button onClick={() => setView('withdrawals')} className={`px-4 py-2 font-semibold ${view === 'withdrawals' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400'}`}>Withdrawal Requests</button>
                <button onClick={() => setView('settings')} className={`px-4 py-2 font-semibold ${view === 'settings' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400'}`}>Settings</button>
            </div>
            {view === 'deposits' && <DepositRequests db={db} showNotification={showNotification} />}
            {view === 'withdrawals' && <WithdrawalRequests db={db} showNotification={showNotification} />}
            {view === 'settings' && <AdminSettings db={db} showNotification={showNotification} />}
        </main>
    );
};

const AdminSettings = ({ db, showNotification }) => {
    const [address, setAddress] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'globalStats', 'singleton');
        getDoc(statsRef).then(docSnap => {
            if (docSnap.exists()) setAddress(docSnap.data().masterDepositAddress || '');
        });
    }, [db]);

    const handleUpdateAddress = async () => {
        if (!address) { showNotification("Address cannot be empty.", "error"); return; }
        setIsLoading(true);
        try {
            const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'globalStats', 'singleton');
            await updateDoc(statsRef, { masterDepositAddress: address });
            showNotification("Deposit address has been updated.", "success");
        } catch(e) {
            showNotification("Update failed.", "error");
            console.error(e);
        } finally { setIsLoading(false); }
    };
    
    return (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
            <h3 className="text-xl font-semibold text-yellow-300">Platform Settings</h3>
            <div>
                <label className="block mb-2 text-sm font-medium text-gray-300">Master Deposit Wallet Address</label>
                <input type="text" value={address} onChange={e => setAddress(e.target.value)} placeholder="ZTMX Deposit Address" className="input-style w-full" />
            </div>
            <button onClick={handleUpdateAddress} disabled={isLoading} className="btn-primary">{isLoading ? 'Updating...' : 'Update Address'}</button>
        </div>
    );
};

const DepositRequests = ({ db, showNotification }) => {
    const [requests, setRequests] = useState([]);
    useEffect(() => {
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'depositRequests'), where('status', '==', 'pending'));
        const unsub = onSnapshot(q, (snapshot) => {
            setRequests(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
        });
        return () => unsub();
    }, [db]);

    const handleRequest = async (reqId, userId, amount, approve = true) => {
        try {
            await runTransaction(db, async (transaction) => {
                const reqRef = doc(db, 'artifacts', appId, 'public', 'data', 'depositRequests', reqId);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);

                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists()) throw new Error("User not found");

                if (approve) {
                    const newBalance = (userDoc.data().availableBalance || 0) + amount;
                    transaction.update(userRef, { availableBalance: newBalance });
                    transaction.update(reqRef, { status: 'approved' });
                } else {
                    transaction.update(reqRef, { status: 'rejected' });
                }
            });
            showNotification(`Request ${approve ? 'approved' : 'rejected'}!`, 'success');
        } catch (e) {
            showNotification("Action failed.", "error");
            console.error(e);
        }
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
             <h3 className="text-xl font-semibold mb-4 text-blue-300">Pending Deposit Requests</h3>
             <div className="space-y-4">
                {requests.length > 0 ? requests.map(req => (
                    <div key={req.id} className="bg-gray-700 p-4 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <p>User: <span className="font-bold text-yellow-300">{req.username}</span></p>
                            <p>Amount: <span className="font-bold text-green-400">{req.amount} ZTMX</span></p>
                            <p className="text-xs text-gray-400 break-all">TxID: {req.txId}</p>
                        </div>
                        <div className="flex gap-2 self-end md:self-center">
                            <button onClick={() => handleRequest(req.id, req.userId, req.amount, true)} className="p-2 bg-green-600 rounded-full hover:bg-green-500"><CheckCircle/></button>
                            <button onClick={() => handleRequest(req.id, req.userId, req.amount, false)} className="p-2 bg-red-600 rounded-full hover:bg-red-500"><XCircle/></button>
                        </div>
                    </div>
                )) : <p className="text-gray-500">No pending requests.</p>}
             </div>
        </div>
    );
};

const WithdrawalRequests = ({ db, showNotification }) => {
    const [requests, setRequests] = useState([]);
    useEffect(() => {
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'withdrawalRequests'), where('status', '==', 'pending'));
        const unsub = onSnapshot(q, (snapshot) => setRequests(snapshot.docs.map(d => ({id: d.id, ...d.data()}))));
        return () => unsub();
    }, [db]);

    const handleConfirm = async (reqId, userId, amount) => {
        try {
            await runTransaction(db, async (transaction) => {
                const reqRef = doc(db, 'artifacts', appId, 'public', 'data', 'withdrawalRequests', reqId);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);

                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists()) throw new Error("User not found");
                
                const totalIncome = Object.values(userDoc.data().income || {}).reduce((a, b) => a + b, 0);
                const currentWithdrawn = userDoc.data().totalWithdrawn || 0;
                
                if (amount > (totalIncome - currentWithdrawn)) throw new Error("User no longer has sufficient funds.");

                transaction.update(userRef, { totalWithdrawn: currentWithdrawn + amount });
                transaction.update(reqRef, { status: 'confirmed' });
            });
            showNotification(`Withdrawal confirmed!`, 'success');
        } catch (e) {
            showNotification(e.message || "Action failed.", "error");
            console.error(e);
        }
    };

    return (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
             <h3 className="text-xl font-semibold mb-4 text-blue-300">Pending Withdrawal Requests</h3>
             <div className="space-y-4">
                {requests.length > 0 ? requests.map(req => (
                    <div key={req.id} className="bg-gray-700 p-4 rounded-lg">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <p>User: <span className="font-bold text-yellow-300">{req.username}</span></p>
                                <p>Amount: <span className="font-bold text-red-400">{req.amount} ZTMX</span></p>
                            </div>
                            <button onClick={() => handleConfirm(req.id, req.userId, req.amount)} className="btn-primary self-end md:self-center">Confirm Payment Sent</button>
                        </div>
                        <p className="text-xs text-gray-400 break-all mt-2 bg-gray-900 p-2 rounded">Address: {req.walletAddress}</p>
                    </div>
                )) : <p className="text-gray-500">No pending requests.</p>}
             </div>
        </div>
    );
};


// --- Helper Functions & Reusable Components (Some are omitted for brevity but would be included) ---

const distributeBonuses = async (db, staker, stakeAmount) => { /* Same as previous version */ };
const Notification = ({ notification, onClose }) => { if (!notification.show) return null; const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' }; return (<div className={`fixed top-5 right-5 z-50 p-4 rounded-lg text-white shadow-lg flex items-center gap-4 ${colors[notification.type]}`}><p>{notification.message}</p><button onClick={onClose}><X size={20}/></button></div>);};
const StatCard = ({ icon, title, value, color }) => {const colors = { blue: 'border-blue-500 text-blue-400', green: 'border-green-500 text-green-400' }; return (<div className={`bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 ${colors[color]}`}><div className="flex items-center gap-4"><div className={`p-3 bg-gray-700/50 rounded-lg ${colors[color]}`}>{icon}</div><div><p className="text-sm text-gray-400">{title}</p><p className="text-xl font-bold text-white">{value}</p></div></div></div>);};
const ReferralSection = ({ user, showNotification }) => { const referralLink = `${window.location.origin}${window.location.pathname}?ref=${user.referralId}`; const copyToClipboard = () => { navigator.clipboard.writeText(referralLink).then(() => showNotification('Referral link copied!'), () => showNotification('Failed to copy', 'error'));}; return (<div className="bg-gray-800 p-6 rounded-xl shadow-lg"><h2 className="text-xl font-semibold mb-4 text-purple-300">Refer & Earn</h2><div className="flex items-center bg-gray-700 rounded-lg p-2"><input type="text" readOnly value={referralLink} className="bg-transparent text-gray-300 w-full outline-none text-sm"/><button onClick={copyToClipboard} className="p-2 text-gray-400 hover:text-white transition"><Copy size={18} /></button></div></div>);};
const RoyaltyStatus = ({ user }) => { const progress = Math.min(((user.teamBusiness || 0) / ROYALTY_QUALIFICATION_BUSINESS) * 100, 100); return (<div className="bg-gray-800 p-6 rounded-xl shadow-lg"><h2 className="text-xl font-semibold mb-2 text-yellow-300">Royalty Status</h2><p className="text-sm text-gray-400 mb-4">Achieve {ROYALTY_QUALIFICATION_BUSINESS.toLocaleString()} ZTMX in team business to qualify.</p><div className="w-full bg-gray-700 rounded-full h-4"><div className="bg-yellow-500 h-4 rounded-full" style={{ width: `${progress}%` }}></div></div><p className="text-right text-sm font-bold mt-2">{progress.toFixed(2)}%</p>{user.isRoyaltyQualified && <p className="text-center font-bold text-green-400 mt-3">Congratulations! You are a Royalty Qualified Leader!</p>}</div>);};
const TeamView = ({ user, db }) => { const [isOpen, setIsOpen] = useState(false); return (<div className="bg-gray-800 p-6 rounded-xl shadow-lg"><button onClick={() => setIsOpen(!isOpen)} className="w-full flex justify-between items-center text-left"><h2 className="text-xl font-semibold text-purple-300">Your Upline</h2>{isOpen ? <ChevronsDown/> : <ChevronsRight/>}</button>{isOpen && (<div className="mt-4 max-h-72 overflow-y-auto pr-2"><p className="text-gray-400 text-sm">Level 1: {user.upline?.[0] || 'N/A'}</p><p className="text-gray-400 text-sm">Level 2: {user.upline?.[1] || 'N/A'}</p></div>)}</div>);};
const TransactionHistory = ({ userId, db }) => { const [transactions, setTransactions] = useState([]); useEffect(() => { const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), where('userId', '==', userId)); const unsub = onSnapshot(q, (snapshot) => { const sorted = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); setTransactions(sorted); }); return () => unsub(); }, [db, userId]); return (<div className="bg-gray-800 p-6 rounded-xl shadow-lg"><h2 className="text-xl font-semibold mb-4 text-blue-300">Transaction History</h2><div className="max-h-96 overflow-y-auto pr-2">{transactions.length > 0 ? (<ul className="space-y-3">{transactions.map(tx => (<li key={tx.id} className="flex justify-between items-center bg-gray-700/50 p-3 rounded-lg"><div><p className="font-medium text-white capitalize">{tx.type.replace(/_/g, ' ')}</p><p className="text-xs text-gray-400">{tx.description}</p></div><div className="text-right"><p className={`font-bold ${tx.type.includes('stake') ? 'text-red-400' : 'text-green-400'}`}>{tx.type.includes('stake') ? '-' : '+'}{tx.amount.toFixed(2)} ZTMX</p><p className="text-xs text-gray-500">{tx.timestamp ? new Date(tx.timestamp.toMillis()).toLocaleDateString() : '...'}</p></div></li>))}</ul>) : <p className="text-gray-500 text-center py-4">No transactions yet.</p>}</div></div>); };

// --- Global Styles ---
const style = document.createElement('style');
style.textContent = `.input-style { background-color: #374151; color: white; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid #4B5563; transition: border-color 0.2s; } .input-style:focus { outline: none; border-color: #FBBF24; } .btn-primary { background-color: #F59E0B; color: #1F2937; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s; } .btn-primary:hover { background-color: #D97706; } .btn-primary:disabled { background-color: #92400E; cursor: not-allowed; }`;
document.head.appendChild(style);

